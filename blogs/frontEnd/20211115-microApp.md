---
title: 理解小程序
date: 2021-11-15
tags:
  - 小程序
categories:
  - frontEnd
---

小程序本质是 `Hybrid App`（混合 App），渲染层走的 `webView`，逻辑层走 `JSCore`（`V8` ：android 内置框架、`JavascriptCore`：iOS 内置框架，App 可以直接使用该框架来运行 JS 代码），两个线程的通信由原生做中转。

<!-- more -->

### 架构图

![小程序架构](https://pic1.zhimg.com/v2-577d754f01920923e08ab03f3e43f5f0_r.jpg)

- **为什么使用双线程模型**：小程序为了体验上更接近原生 App，一个页面对应一个 webview，存储到页面栈中，而 webview 之间是天然隔离的，上下文不共享，所以独立出逻辑层，使整个小程序生命周期中上下文一致，这样，webview 只负责页面渲染，事件处理统一在逻辑线程处理，由微信原生通信，而处理好的数据再由原生传给渲染层更新 UI。

### 小程序启动

- **冷启动**：如果用户首次打开（届时会先下载小程序包），或小程序销毁后再被打开，此时小程序会重新加载启动，即冷启动。
- **热启动**：如果用户已经打开过某个小程序，30 分钟之内再次打开，不会重新加载，只是从后台切换到前台，即热启动。

### 销毁

- 宿主 App 被杀死时，小程序自然也会被销毁。
- 当小程序进入后台被挂起超过 30 分钟，都没有进入前台，小程序会被销毁。
- 当小程序占用系统资源过高时，会被微信主动销毁。

### 更新

- **未启动时更新**：微信运行时，会定期检查最近使用的小程序是否有更新，如果有则会下载更新。
- **启动更新**：小程序每次冷启动都会异步检查是否有更新，如果有则会下载，但是此次仍然是旧版本。

### 遇到问题

- **问题**：同一个长表单在浏览器渲染很快，但是在小程序渲染很慢（iphone12 大概白屏 2-3 秒），很奇怪，小程序基于 webview 渲染，理论上两者的渲染能力是一样的，为什么一个快一个慢？
- **原因**：**同一时间调用 `setData` 频率太高，导致通信队列阻塞**。因为小程序是双线程模型，逻辑层跟渲染层分别在两个不同的线程执行，由微信`JSBridge`来做通信，调用 `setData` 会通知渲染层更新 UI，所以太频繁就会导致通信队列阻塞，页面渲染不及时，表现上就很卡。
- **解决方案**：用定时器将表单分页加载，每 0.2 秒加载 1 页，分 6 页加载，降低同一时间调用 `setData` 的频率，保证首页快速加载。

```js
// 分页加载
pageLoading(totalPage = 6) {
  return new Promise((resolve) => {
    let intervalId = setInterval(() => {
      this.currentPage++;
      if (this.currentPage >= totalPage) {
        clearInterval(intervalId);
        resolve()
      }
    }, 200);
  });
}
```
