---
title: 编译链接过程
date: 2021-09-14
tags:
  - 计算机基础
categories:
  - iOS
---

### 简要

总体过程：预编译->编译->汇编->链接。<br>
编译生成`.o` 的二进制目标文件，链接合并所有`.o` 文件并把符号绑定到虚拟内存地址上。

<!-- more -->

### 编译

1. 预编译
   - 删除所有注释。
   - 删除`#define`，并展开所有的宏定义。
   - 处理条件编译指令：`#if`、`#ifdef`、`#elif`，`#else`、`#endif`。
   - 展开`#include`、`#import`引入的头文件。
2. 编译
   - 词法分析，从左往右逐行扫描源程序的字符，将代码切分成 `Token`（词法单元，最小单位的字符或字符组合）。
   - 语法分析，将输出的`Token`组合成语义，并根据节点构建`AST`（抽象语法树）。
   - 静态分析，对代码进行错误检查，比如类型未定义、类型不匹配等问题。
   - 生成中间代码，通过`AST`生成`IR`（一种更接近机器码的语言，与平台无关，可以生成适合不同平台的机器码）。
   - 生成汇编代码，将中间代码生成依赖具体机器的汇编代码，得到`.s`汇编文件。
3. 汇编
   - 将`.s`的汇编代码翻译成机器指令，得到`.o`目标文件，即二进制文件。

### 链接

1. 合并所有`.o`
   - 合并各个段，`.text`(代码段)、`.data`(已初始化的全局静态变量)、`.bss`(未初始化的全局静态变量)、`.symbal`(符号表)、`section table`(段表)。
   - 符号解析，符号表合并之后进行符号解析，所有对符号的引用都要找到该符号定义的地方，常见错误：符号未定义、符号重定义。
2. 符号重定位
   - 符号解析成功后，会进行符号重定位，即**给所有符号分配虚拟内存地址**（动态链接在启动时分配）。

### 扩展

- 链接方式
  - 静态链接：也就是编译链接，会把编译生成的`.o` 目标文件合并成一个 `Mach-O` 可执行文件，并载入`.app` 包中。
  - 动态链接：在程序启动时，加载 dyld 来做符号重定位，动态库没有复制到可执行文件中。
- 死代码剥离
  - 静态链接器有一个 `Dead Code Stripping` 功能，默认会清理 C C++ Swift 中的无用函数，以 main 函数为源头，跟随每个引用做标记，没有标记上的就会自动去除，但是对 OC 无效，因为 OC 是动态调用的，所以一般静态库要比动态库包要小一些。
- 偏移地址
  - 函数在编译链接后得到的可执行文件中，就确定了其函数地址的偏移量，偏移量是固定的，而可执行文件每次加载到内存中的首地址是变化的，那么运行时函数指针地址就是 offset+Mach-O 文件在内存中的首地址。
